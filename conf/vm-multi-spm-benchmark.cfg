-- vim:set ft=lua:

local L4 = require("L4");
local ld = L4.default_loader;

local spmm_channel = ld:new_channel();
local cons         = ld:new_channel();

ld:start(
  {
    caps = { spmm_allocator = spmm_channel:svr() },
    log = { "spmm", "yellow" }
  },
  "rom/spmm"
);

ld:start(
  {
    caps = { cons = cons:svr(); },
    log = L4.Env.log
  },
  "rom/cons -a"
);

ld.log_fab = cons:svr();

function start_vm(num)
  ld:startv(
    {
      caps = {
        ram = spmm_channel:create(
          --[[ protocol: ]] L4.Proto.Dataspace,
          --[[ size:     ]] 1024 * 1024 * 1024,
          --[[ flags:    ]] 7,
          --[[ align:    ]] 28
          ):m("rws"); 
      },
      log = { "vm-" .. num, "", "key=" .. num },
    },
    "rom/uvmm", "-v",
       "-krom/linux",
       "-rrom/ramdisk-" .. L4.Info.arch() .. ".rd",
       "-drom/virt-arm_virt-64.dtb",
       "-cconsole=hvc0 ramdisk_size=300000 root=/dev/ram0 rw");
end

start_vm(1)
start_vm(2)
