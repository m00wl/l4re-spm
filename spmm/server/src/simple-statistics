// vim:set ft=cpp:

#pragma once

#include <mutex>
#include <time.h>

#include "statistics"

namespace Spmm
{

class SimpleStatistics : public Statistics
{
private:
  unsigned int _pages_shared   = 0;
  unsigned int _pages_sharing  = 0;
  /* unsigned int _pages_saved = _pages_sharing - _pages_shared; */
  unsigned int _pages_unshared = 0;
  unsigned int _full_scans     = 0;
  std::mutex _m;

public:
  void get_stats()
  {
    time_t my_time = time(NULL);
    printf("spm statistics:\n");
    printf("time:\t%s", ctime(&my_time));
    printf("pages_total:\t%u\n", _pages_unshared + _pages_sharing);
    printf("pages_unshared:\t%u\n", _pages_unshared);
    printf("pages_sharing:\t%u\n", _pages_sharing);
    printf("pages_shared:\t%u\n", _pages_shared);
    printf("pages_saved:\t%u\n", _pages_sharing - _pages_shared);
    printf("full_scans:\t%u\n", _full_scans);
    printf("\n");
  }

  void inc_pages_shared(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_shared += n;
  }

  void dec_pages_shared(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_shared -= n;
  }

  void inc_pages_sharing(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_sharing += n;
  }

  void dec_pages_sharing(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_sharing -= n;
  }

  void inc_pages_unshared(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_unshared += n;
  }

  void dec_pages_unshared(unsigned int n) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _pages_unshared -= n;
  }

  void inc_full_scans(void) override
  {
    std::lock_guard<std::mutex> const lock(_m);
    _full_scans++;
    this->get_stats();
  }
};

} //Spmm
